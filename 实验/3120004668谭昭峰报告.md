[TOC]

# 实验一 X.509证书/PKI 配置操作

## 1 实验题目

使用 JDK 自带的证书创建工具keytool完成证书的申请和签发操作。

## 2 实验目的

- 了解公钥加密体制（非对称密码体制的基本原理）。
- 理解数字证书的基本概念及其在安全体制中的应用。
- 理解密钥的生成和管理。
- 掌握利用keytool 工具实现数字证书的管理。

## 3 实验原理与理论基础

### 3.1 非对称加密

使用一对密钥：一个用于加密信息，另一个则用于解密信息。

两个密钥之间存在着相互依存关系：即用其中任一个密钥加密的信息只能用另一个密钥进行解密。

其中加密密钥不同于解密密钥,公钥加密私钥解密，反之也可私钥加密公钥解密。

密钥依据性质划分，将其中的一个向外界公开，称为公钥；另一个则自己保留，称为私钥。公钥(Public key)常用于数据加密（用对方公钥加密）或签名验证（用对方公钥解密），私钥(Private key)常用于数据解密（发送方用接收方公钥加密）或数字签名（用自己私钥加密）。

机密性、完整性、抗抵赖性

### 3.2 在通信过程中，非对称加密通信的过程是怎样？

1.乙方生成两把密钥（公钥和私钥）

2.甲方获取乙方的公钥，然后用它对信息加密。

3.乙方得到加密后的信息，用私钥解密，乙方也可用私钥加密字符串

4.甲方获取乙方私钥加密数据，用公钥解密

优点：难破解

缺点: 加密速度慢

常用算法：

RSA、Elgamal、背包算法、Rabin、D-H、ECC（椭圆曲线加密算法)



### 3.3 怎样利用数字证书提供身份认证？

1. 认证方向被认证方发送一个随机数；
2. 被认证方使用自己的私钥，对认证方提供的随机数进行加密；
3. 被认证方将自己的签名证书和密文发送给认证方；
4. 认证方验证被认证方所提供的签名证书有效期、证书链，并完成黑名单检查，失败则放弃；
5. 有效期、证书链和黑名单验证通过后，认证方使用被认证方的签名证书对被认证方提供的密文进行解密，将认证方提供给被认证方的随机数与解密结果进行对比，相等则表明可以接受被认证方提交的签名证书所申明的身份。

### 3.4 keytool用法

- 使用keytool工具时可以使用如下命令

  ```
  C:\>keytool
  密钥和证书管理工具
   
  命令:
   
   -certreq            生成证书请求
   -changealias        更改条目的别名
   -delete             删除条目
   -exportcert         导出证书
   -genkeypair         生成密钥对
   -genseckey          生成密钥
   -gencert            根据证书请求生成证书
   -importcert         导入证书或证书链
   -importpass         导入口令
   -importkeystore     从其他密钥库导入一个或所有条目
   -keypasswd          更改条目的密钥口令
   -list               列出密钥库中的条目
   -printcert          打印证书内容
   -printcertreq       打印证书请求的内容
   -printcrl           打印 CRL 文件的内容
   -storepasswd        更改密钥库的存储口令
   
  使用 "keytool -command_name -help" 获取 command_name 的用法
  ```


- 要了解某个命令的参数可以使用keytool –command_name –help来获取。例如：使用keytool –genkeypair –help可以查看genkeypair命令的参数说明

  ```
  
  C:\>keytool -genkeypair -help
  keytool -genkeypair [OPTION]...
   
  生成密钥对
   
  选项:
   
   -alias <alias>                  要处理的条目的别名
   -keyalg <keyalg>                密钥算法名称
   -keysize <keysize>              密钥位大小
   -sigalg <sigalg>                签名算法名称
   -destalias <destalias>          目标别名
   -dname <dname>                  唯一判别名
   -startdate <startdate>          证书有效期开始日期/时间
   -ext <value>                    X.509 扩展
   -validity <valDays>             有效天数
   -keypass <arg>                  密钥口令
   -keystore <keystore>            密钥库名称
   -storepass <arg>                密钥库口令
   -storetype <storetype>          密钥库类型
   -providername <providername>    提供方名称
   -providerclass <providerclass>  提供方类名
   -providerarg <arg>              提供方参数
   -providerpath <pathlist>        提供方类路径
   -v                              详细输出
   -protected                      通过受保护的机制的口令
   
  使用 "keytool -help" 获取所有可用命令
  ```

  

## 4 实验内容

- 证书的生成
- 证书的签发

## 5 实验结果

### 5.1证书的生成

1.生成keystore证书库以及秘钥对

![1](img\1.png)

2.查看keystore的秘钥

![2](img\2.png)

3.导出公钥证书

![3](img\3.png)

​	![4](img\4.png)

### 5.2证书的签发

1.导出文本格式的证书签名请求文件

![6](img\6.png)

![7](img\7.png)

2.本地生成一个cacert 的证书表示有资质的签发机构

![5](img\5.png)

3.用cacert keystore中的cacert证书的私钥，签发springtest的csr文件

![8](img\8.png)

本地生成了签发后的证书

![9](img\9.png)

## 6 实验结果分析

​	一个密钥库可以存放多个密钥项目和多个信任证书项目，密钥库中每个项目与唯一别名(alias)关联。Java对密钥库和密钥项目提供用口令(加密)保护。

​	Java平台提供的keytool程序可以从命令行管理密钥库。

​	用以下命令可以生成银行和客户的私有密钥/公开密钥对:

​	keytool -genkey -keystore -alidity 720 表示密钥库文件名。

​	在执行命令时 keytool 会提示输入一些个人信息，用于生成专用证书的主题(Subject)，主题包含了一些证书持有人的信息。本文提出的方案，

​	客户证书用其中CN域保存支付帐号。

​	用keytool -export -keystore -file -rfc，可以输出以为文件名的信任数字证书。可以把信任证书发放给信息的接收方。

​	在应用程序中，使用java.security.Keystore类访问和管理密钥库，Keystore类可以读取密钥库中的密钥和证书信息。

​	Keystore类是个抽象类，由加密服务提供者(CsP)特定实现方法实现。Keystore对象实例用静态方法getlnstance(string type)生成。

​	tyPe为密钥库类型，Java平台默认密钥库类型为 JKS。生成 Keystore对象后，用load(Inputstreamstream，char[]password)从指定输入流装入Keystore 对象，口令Password用于验证密钥库数据完整性。用getKey(Stringalias，charllpassword)返回别名为alias的密钥项目，password是密钥的解密口令。用getCertificate(String alias) 返回别名为alias的证书项目，getCertificate返回一java.security.cert.Cer-tificate 对象，Certificate对象用getpublicKeyo可以读出证书中的公开密钥。



# 实验二 SSL/TLS 配置与分析

## 1 实验题目

学会配置SSL/TLS。利用网络抓包软件分别对使用安全协议和未使用安全协议两种情况下数据报的不同，从而理解安全协议的作用。

## 2 实验目的

1. 学会配置SSL/TLS协议
2. 掌握利用wireshark对数据抓包分析

## 3 实验原理与理论基础

### 3.1 什么是SSL

​	SSL(Secure Sockets Layer 安全套接层)，及其继任者传输层安全（Transport Layer Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层对网络连接进行加密。
​	SSL协议位于TCP/IP协议与各种应用层协议之间，为数据通讯提供安全支持。SSL协议可分为两层： SSL记录协议（SSL Record Protocol）：它建立在可靠的传输协议（如TCP）之上，为高层协议提供数据封装、压缩、加密等基本功能的支持。 SSL握手协议（SSL Handshake Protocol）：它建立在SSL记录协议之上，用于在实际的数据传输开始前，通讯双方进行身份认证、协商加密算法、交换加密密钥等。

### 3.2 SSL所提供的服务

提供的服务如下：

- 认证用户和服务器，确保数据发送到正确的客户机和服务器；
- 加密数据以防止数据中途被窃取；
- 保证数据的完整性，确保数据在传输过程中不被改变。

### 3.3 SSL工作流程

服务器认证阶段：
1. 客户端向服务器发送一个开始信息“Hello”以便开始一个新的会话连接；

2. 服务器根据客户的信息确定是否需要生成新的主密钥，如需要则服务器在响应客户的“Hello”信息时将包含生成主密钥所需的信息；

3. 客户根据收到的服务器响应信息，产生一个主密钥，并用服务器的公开密钥加密后传给服务器；

4. 服务器回复该主密钥，并返回给客户一个用主密钥认证的信息，以此让客户认证服务器。
    **用户认证阶段：**在此之前，服务器已经通过了客户认证，这一阶段主要完成对客户的认证。经认证的服务器发送一个提问给客户，客户则返回
    （数字）签名后的提问和其公开密钥，从而向服务器提供认证。

  **SSL协议提供的安全通道有以下三个特性：**

  - 机密性：SSL协议使用密钥加密通信数据。

  - 可靠性：服务器和客户都会被认证，客户的认证是可选的。
  - 完整性：SSL协议会对传送的数据进行完整性检查。



## 4 实验内容

1. 配置SSL/TLS协议
2. 对数据进行抓包并分析



## 5 实验结果

### 5.1 前提

实验方法是用手机访问电脑的ip进行抓包分析。

电脑的ip：

![10](img\10.png)

手机的ip：

![11](img\11.png)

### 5.2 配置服务器

- 勾选如图所示的选项，确定即可

![12](img\12.png)

- 如下图，打开IIS管理器

  ![13](img\13.png)

- 网站右键->添加网站->确定

![14](img\14.png)

- 继续配置网站的权限：右键刚刚新建的网站->选择"编辑权限"->安全->编辑->添加，确定

![15](img\15.png)

- 授予权限后确定

![16](img\16.png)

- 在物理路径下创建index.html，访问自己的ip进入则说明配置成功

![17](img\17.png)

### 5.3 没有使用ssl的情况下抓包

- 使用手机访问电脑的ip，抓包的情况

![18](img\18.png)

- 查看200 OK的那个包，可以看到赤裸裸的数据

![19](img\19.png)

### 5.4 为网站配置SSL

- 在IIS打开服务器证书，创建自签名证书

![20](img\20.png)

![21](img\21.png)

- 重新添加网站，像上面的配置一样，不过此时绑定类型选为https，在最下面导入自己刚刚创键的证书。

![22](img\22.png)

### 5.5 对使用SSL的网站进行抓包

- 可以看到网站已经使用了https协议，因为两边都需要ssl，所以在Wireshark里抓包只会显示TCP握手协议的。

![23](img\23.png)

## 6 实验结果分析

​	本实验关键在于比较使用SSL协议和不使用的区别，为了简单且受设备影响，win10上如何给IIS设置证书涉及到诸多配置，本次实验中使用自签名证书代替ssl证书，同样达到了实验目的，通过对http与https分别抓包分析，使我理解了ssl协议的存在价值，它加大了中间人的攻击成本，让数据不易被窃取，保证数据传输中不被窃取、改变，保证了数据传输的完整性。

# 实验三 IPSec协议配置与分析

## 1 实验题目

学会配置IPSec协议。利用网络抓包软件分别对使用安全协议和未使用安全协议两种情况下数据报的不同，从而理解安全协议的作用。

## 2 实验目的

1. IPSec协议配置与分析

2. 配置 IPSec 协议

3. 对数据进行抓包并分析

   

## 3 实验原理与理论基础

### Ipsec

**互联网安全协议**（英语：Internet Protocol Security，缩写为IPsec），是一个协议簇，通过对IP协议的分组进行加密和认证来保护IP协议的网络传输

协议族（一些相互关联的协议的集合）。 IPsec主要由以下协议组成：

1. 认证头（AH），为IP数据报提供无连接数据完整性、消息认证以及防重放攻击保护；

2. 封装安全载荷（ESP），提供机密性、数据源认证、无连接完整性、防重放和有限的传输流（traffic-flow）机密性；

3. 安全关联（SA），提供算法和数据包，提供AH、ESP操作所需的参数。

4. 密钥协议（IKE），提供对称密码的钥匙的生存和交换。

## 4 实验内容

1. 比较配置IPSec前后对主机的访问的区别

2. 实验两台主机都配置IpSec后的相互通信

## 5 实验结果

### 5.1 配置Ipsec

- 开始--->所有应用--->Wondows 管理工具--->本地安全策略

![24](img\24.png)

- 启动后界面

![25](img\25.png)

- 鼠标右键增加新的规则

![26](img\26.png)

- 下一步，。。。一直到属性窗口，添加

![27](img\27.png)

- 下一步，不指定隧道

- 下一步，所有网络

- 下一步，添加出现如下窗口，添加

![28](img\28.png)

- 增加筛选器
  筛选器要选择协商安全

![29](img\29.png)

- 下一步增加身份验证方法
  输入 abcdef

![30](img\30.png)

- 指派

### 5.2 配置后结果

- 增加一条新 IP 安全策略

![31](img\31.png)

- 打开后如下：

![32](img\32.png)

- 选中后点击编辑
  显示如下窗口

![33](img\33.png)

下面分别查看

- IP 筛选列表

可以设置源、目ip和端口及服务类别



- 筛选操作

设置符合该ip规则的输入输出流该如何处理，一般可以选择协商安全

- 身份验证方法

可以使用的身份验证方法，有证书和预共享密钥方法

- 隧道设置

可以设置隧道端点，如果不设置为传输方式

- 连接类型

### 5.3 开始通信

- 对手机 192.168.0.102 进行ping操作

![34](img\34.png)

- 对通信进行抓包如下

![35](img\35.png)

可以看到10.0.2.15一直在发包，请求IPsec 的SA，但总是不成功。

## 6 实验结果分析

实验进行到这一步已经进行不下去了，在家无法下载老师的虚拟机又没有第二台电脑，在网上找的winxp镜像自己配置不是报错就是没有本地安全策略。